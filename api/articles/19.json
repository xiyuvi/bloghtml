{"title":"使用GitHub Action分布式部署静态网站","slug":"19","date":"2022-10-27T13:08:53.000Z","updated":"2022-10-27T13:08:53.000Z","comments":true,"path":"api/articles/19.json","excerpt":null,"covers":null,"content":"<h2 id=\"什么是GitHub-Action\"><a href=\"#什么是GitHub-Action\" class=\"headerlink\" title=\"什么是GitHub Action\"></a>什么是GitHub Action</h2><p>通俗的理解GitHub Action是通过push代码等方式自动触发运行用户提前编写好的工作流脚本，这些脚本会运行在GitHub提供的虚拟机中，虚拟机会像机器人流水线作业一样一步一步来完成这些复杂频繁的的工作流程，解放人力。</p>\n<h2 id=\"分布式部署网站\"><a href=\"#分布式部署网站\" class=\"headerlink\" title=\"分布式部署网站\"></a>分布式部署网站</h2><p>目前我使用的网站结构在两个git仓库使用了两个GitHub Action流程，如下流程图所示：每次push博客生成器源码git仓库后，执行GitHub Action工作流程，将编译好的网站html源码push到另一个存放网站html代码的git仓库以及gitee备用仓库。存放html源码的仓库在收到push后又会触发自己仓库的GitHub Action，把html代码上传到阿里云oss中。</p>\n\n<pre>\n<code class=\"mermaid\" >\ngraph TB\n    A[本地书写文章] -- 主动推送 --> B[(github-hexo静态网页生成器源码仓库)];\n    B -- GitHub Action one --> C[(github-html代码仓库)];\n    B -- GitHub Action one --> D[(gitee-html代码备用仓库)];\n    C -- GitHub Action two --> E[(阿里云OSS)];\n    \n</code>\n</pre>\n\n\n<p>看起来有些繁琐但是人工参与的只有第一步向仓库push代码，剩下的步骤都由勤劳的GitHub Action来自动集成。网站访客在访问域名后，dns会根据访客ip智能把请求到最佳节点。”github-html代码仓库”开启了git pages用于国外访客的域名解析,阿里云OSS用于国内ip的访客使用,并且使用了cdn访问速度飞快。gitee备用仓库由于监管原因不能绑定自定义域名暂无使用只是用于备份存储，整个访问流程如下所示。</p>\n\n<pre>\n<code class=\"mermaid\" >\ngraph LR\n    A[网站访客] --> B{dns判断访客IP?};\n    B -- 是国内访问,解析至 --> C[阿里云cdn];\n    C -.-> D[阿里云OSS];\n    B -- 否,国外访问,解析至 ---> E[gitPages网页托管];\n</code>\n</pre>\n\n<h2 id=\"GitHub-Action代码\"><a href=\"#GitHub-Action代码\" class=\"headerlink\" title=\"GitHub Action代码\"></a>GitHub Action代码</h2><p>上面这些繁琐的工作都是靠下面两个GitHub Action实现</p>\n<h3 id=\"博客生成器仓库的GitHub-Action-one\"><a href=\"#博客生成器仓库的GitHub-Action-one\" class=\"headerlink\" title=\"博客生成器仓库的GitHub Action one\"></a>博客生成器仓库的GitHub Action one</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-comment\"># Action 的名字</span><br><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Hexo</span> <span class=\"hljs-string\">Auto</span> <span class=\"hljs-string\">Deploy</span><br><br><span class=\"hljs-attr\">on:</span><br>  <span class=\"hljs-comment\"># 触发条件1：main 分支收到 push 后执行任务。</span><br>  <span class=\"hljs-attr\">push:</span><br>    <span class=\"hljs-attr\">branches:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">main</span><br>  <span class=\"hljs-comment\"># 触发条件2：手动按钮</span><br>  <span class=\"hljs-attr\">workflow_dispatch:</span><br><br><span class=\"hljs-comment\"># 这里放环境变量,需要替换成你自己的</span><br><span class=\"hljs-attr\">env:</span><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 git 用户部署到 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_USER:</span> <span class=\"hljs-string\">xiyuvi</span><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 git 邮箱部署到 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_EMAIL:</span> <span class=\"hljs-number\">20702001</span><span class=\"hljs-string\">@qq.com</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署的 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_DEPLOY_REPO:</span> <span class=\"hljs-string\">xiyuvi/xiyuvi.github.io</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署到的分支</span><br>  <span class=\"hljs-attr\">GIT_DEPLOY_BRANCH:</span> <span class=\"hljs-string\">main</span><br><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 gitee 用户部署到gitee仓库</span><br>  <span class=\"hljs-attr\">GITEE_USER:</span> <span class=\"hljs-string\">xiyu</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署的 gitee 仓库</span><br>  <span class=\"hljs-attr\">GITEE_DEPLOY_REPO:</span> <span class=\"hljs-string\">xiyu/bloghtml</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署到的分支</span><br>  <span class=\"hljs-attr\">GITEE_DEPLOY_BRANCH:</span> <span class=\"hljs-string\">main</span><br><br>  <span class=\"hljs-comment\"># 注意替换为你的 GitHub 源仓库地址</span><br>  <span class=\"hljs-attr\">GIT_SOURCE_REPO:</span> <span class=\"hljs-string\">git@github.com:xiyuvi/xiyuvi.github.io.git</span><br>  <span class=\"hljs-comment\"># 注意替换为你的 Gitee 目标仓库地址</span><br>  <span class=\"hljs-attr\">GITEE_DESTINATION_REPO:</span> <span class=\"hljs-string\">git@gitee.com:xiyu/bloghtml.git</span><br><br><span class=\"hljs-attr\">jobs:</span><br>  <span class=\"hljs-attr\">build:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span> <span class=\"hljs-string\">on</span> <span class=\"hljs-string\">node</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.os</span> <span class=\"hljs-string\">&#125;&#125;</span><br>    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span><br>    <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">github.event.repository.owner.id</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">github.event.sender.id</span><br>    <span class=\"hljs-attr\">strategy:</span><br>      <span class=\"hljs-attr\">matrix:</span><br>        <span class=\"hljs-attr\">os:</span> [<span class=\"hljs-string\">ubuntu-18.04</span>]<br>        <span class=\"hljs-attr\">node_version:</span> [<span class=\"hljs-number\">12.</span><span class=\"hljs-string\">x</span>]<br><br>    <span class=\"hljs-attr\">steps:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">repo</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-attr\">repository:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_DEPLOY_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-attr\">ref:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_DEPLOY_BRANCH</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">.deploy_git</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Use</span> <span class=\"hljs-string\">Node.js</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Configuration</span> <span class=\"hljs-string\">environment</span><br>        <span class=\"hljs-attr\">env:</span><br>          <span class=\"hljs-attr\">HEXO_DEPLOY_PRI:</span> <span class=\"hljs-string\">$&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;&#125;</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          sudo timedatectl set-timezone &quot;Asia/Shanghai&quot;</span><br><span class=\"hljs-string\">          mkdir -p ~/.ssh/</span><br><span class=\"hljs-string\">          echo &quot;$HEXO_DEPLOY_PRI&quot; &gt; ~/.ssh/id_rsa</span><br><span class=\"hljs-string\">          chmod 600 ~/.ssh/id_rsa</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa github.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          # coding 已取消同步</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa e.coding.net &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa gitee.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          git config --global user.name $GIT_USER</span><br><span class=\"hljs-string\">          git config --global user.email $GIT_EMAIL</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">dependencies</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          npm install hexo-cli -g</span><br><span class=\"hljs-string\">          npm install</span><br><span class=\"hljs-string\">          # 根据你安装的组件进行安装</span><br><span class=\"hljs-string\">          # npm uninstall hexo-generator-index --save</span><br><span class=\"hljs-string\">          # npm install hexo-baidu-url-submit hexo-generator-index2 hexo-symbols-count-time hexo-blog-encrypt hexo-deployer-git --save</span><br><span class=\"hljs-string\">          # 复制中文语言包，解决菜单英文的问题</span><br><span class=\"hljs-string\">          # cp zh-CN.yml node_modules/hexo-theme-next/languages/</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Deploy</span> <span class=\"hljs-string\">hexo</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          npm run deploy</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Sync</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">Gitee</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">wearerequired/git-mirror-action@master</span><br>        <span class=\"hljs-attr\">env:</span><br>          <span class=\"hljs-comment\"># 直接使用了 HEXO_DEPLOY_PRI</span><br>          <span class=\"hljs-attr\">SSH_PRIVATE_KEY:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.HEXO_DEPLOY_PRI</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-comment\"># GitHub 源仓库地址</span><br>          <span class=\"hljs-attr\">source-repo:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_SOURCE_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-comment\"># Gitee 目标仓库地址</span><br>          <span class=\"hljs-attr\">destination-repo:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GITEE_DESTINATION_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br><br>      <span class=\"hljs-comment\"># - name: Build Gitee Pages</span><br>        <span class=\"hljs-comment\"># uses: yanglbme/gitee-pages-action@main</span><br>        <span class=\"hljs-comment\"># with:</span><br>          <span class=\"hljs-comment\"># 你的 Gitee 用户名</span><br>          <span class=\"hljs-comment\"># gitee-username: $&#123;&#123; env.GITEE_USER &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 注意在 Settings-&gt;Secrets 配置 GITEE_PASSWORD</span><br>          <span class=\"hljs-comment\"># gitee-password: $&#123;&#123; secrets.GITEE_PASSWORD &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 你的 Gitee 仓库，仓库名严格区分大小写，请准确填写，否则会出错</span><br>          <span class=\"hljs-comment\"># gitee-repo: $&#123;&#123; env.GITEE_DEPLOY_REPO &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 要部署的分支，默认是 master，若是其他分支，则需要指定（指定的分支必须存在）</span><br>          <span class=\"hljs-comment\"># branch: $&#123;&#123; env.GITEE_DEPLOY_BRANCH &#125;&#125;</span><br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"html代码仓库的GitHub-Action-two\"><a href=\"#html代码仓库的GitHub-Action-two\" class=\"headerlink\" title=\"html代码仓库的GitHub Action two\"></a>html代码仓库的GitHub Action two</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ossWorkflow</span><br><br><span class=\"hljs-attr\">on:</span> [<span class=\"hljs-string\">push</span>]<br><br><span class=\"hljs-attr\">jobs:</span><br>  <span class=\"hljs-attr\">build:</span><br>    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span><br>    <span class=\"hljs-attr\">steps:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v1</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span><br>      <span class=\"hljs-attr\">with:</span><br>        <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-string\">&quot;12.x&quot;</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span> <span class=\"hljs-string\">Blog</span><br>      <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">        npm install</span><br><span class=\"hljs-string\"></span>        <br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">manyuanrong/setup-ossutil@master</span><br>      <span class=\"hljs-attr\">with:</span><br>        <span class=\"hljs-comment\"># endpoint 可以去oss控制台上查看</span><br>        <span class=\"hljs-attr\">endpoint:</span> <span class=\"hljs-string\">&quot;oss-cn-chengdu.aliyuncs.com&quot;</span><br>        <span class=\"hljs-comment\"># 使用我们之前配置在secrets里面的accesskeys来配置ossutil</span><br>        <span class=\"hljs-attr\">access-key-id:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.KEY</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">access-key-secret:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.SECRET</span> <span class=\"hljs-string\">&#125;&#125;</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Deply</span> <span class=\"hljs-string\">To</span> <span class=\"hljs-string\">OSS</span><br>      <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">        cp -ri  ./   ../output</span><br><span class=\"hljs-string\">        cd ../output</span><br><span class=\"hljs-string\">        rm -rf .git .github</span><br><span class=\"hljs-string\">        ossutil cp ./ oss://xiyublog/ -rf</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>GitHub Action还能用来做更多可以自动集成化的事情，希望大家都能挖掘出更多有意义的用法 。 </p>\n","more":"<h2 id=\"什么是GitHub-Action\"><a href=\"#什么是GitHub-Action\" class=\"headerlink\" title=\"什么是GitHub Action\"></a>什么是GitHub Action</h2><p>通俗的理解GitHub Action是通过push代码等方式自动触发运行用户提前编写好的工作流脚本，这些脚本会运行在GitHub提供的虚拟机中，虚拟机会像机器人流水线作业一样一步一步来完成这些复杂频繁的的工作流程，解放人力。</p>\n<h2 id=\"分布式部署网站\"><a href=\"#分布式部署网站\" class=\"headerlink\" title=\"分布式部署网站\"></a>分布式部署网站</h2><p>目前我使用的网站结构在两个git仓库使用了两个GitHub Action流程，如下流程图所示：每次push博客生成器源码git仓库后，执行GitHub Action工作流程，将编译好的网站html源码push到另一个存放网站html代码的git仓库以及gitee备用仓库。存放html源码的仓库在收到push后又会触发自己仓库的GitHub Action，把html代码上传到阿里云oss中。</p>\n\n<pre>\n<code class=\"mermaid\" >\ngraph TB\n    A[本地书写文章] -- 主动推送 --> B[(github-hexo静态网页生成器源码仓库)];\n    B -- GitHub Action one --> C[(github-html代码仓库)];\n    B -- GitHub Action one --> D[(gitee-html代码备用仓库)];\n    C -- GitHub Action two --> E[(阿里云OSS)];\n    \n</code>\n</pre>\n\n\n<p>看起来有些繁琐但是人工参与的只有第一步向仓库push代码，剩下的步骤都由勤劳的GitHub Action来自动集成。网站访客在访问域名后，dns会根据访客ip智能把请求到最佳节点。”github-html代码仓库”开启了git pages用于国外访客的域名解析,阿里云OSS用于国内ip的访客使用,并且使用了cdn访问速度飞快。gitee备用仓库由于监管原因不能绑定自定义域名暂无使用只是用于备份存储，整个访问流程如下所示。</p>\n\n<pre>\n<code class=\"mermaid\" >\ngraph LR\n    A[网站访客] --> B{dns判断访客IP?};\n    B -- 是国内访问,解析至 --> C[阿里云cdn];\n    C -.-> D[阿里云OSS];\n    B -- 否,国外访问,解析至 ---> E[gitPages网页托管];\n</code>\n</pre>\n\n<h2 id=\"GitHub-Action代码\"><a href=\"#GitHub-Action代码\" class=\"headerlink\" title=\"GitHub Action代码\"></a>GitHub Action代码</h2><p>上面这些繁琐的工作都是靠下面两个GitHub Action实现</p>\n<h3 id=\"博客生成器仓库的GitHub-Action-one\"><a href=\"#博客生成器仓库的GitHub-Action-one\" class=\"headerlink\" title=\"博客生成器仓库的GitHub Action one\"></a>博客生成器仓库的GitHub Action one</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-comment\"># Action 的名字</span><br><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Hexo</span> <span class=\"hljs-string\">Auto</span> <span class=\"hljs-string\">Deploy</span><br><br><span class=\"hljs-attr\">on:</span><br>  <span class=\"hljs-comment\"># 触发条件1：main 分支收到 push 后执行任务。</span><br>  <span class=\"hljs-attr\">push:</span><br>    <span class=\"hljs-attr\">branches:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">main</span><br>  <span class=\"hljs-comment\"># 触发条件2：手动按钮</span><br>  <span class=\"hljs-attr\">workflow_dispatch:</span><br><br><span class=\"hljs-comment\"># 这里放环境变量,需要替换成你自己的</span><br><span class=\"hljs-attr\">env:</span><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 git 用户部署到 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_USER:</span> <span class=\"hljs-string\">xiyuvi</span><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 git 邮箱部署到 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_EMAIL:</span> <span class=\"hljs-number\">20702001</span><span class=\"hljs-string\">@qq.com</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署的 github 仓库</span><br>  <span class=\"hljs-attr\">GIT_DEPLOY_REPO:</span> <span class=\"hljs-string\">xiyuvi/xiyuvi.github.io</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署到的分支</span><br>  <span class=\"hljs-attr\">GIT_DEPLOY_BRANCH:</span> <span class=\"hljs-string\">main</span><br><br>  <span class=\"hljs-comment\"># Hexo 编译后使用此 gitee 用户部署到gitee仓库</span><br>  <span class=\"hljs-attr\">GITEE_USER:</span> <span class=\"hljs-string\">xiyu</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署的 gitee 仓库</span><br>  <span class=\"hljs-attr\">GITEE_DEPLOY_REPO:</span> <span class=\"hljs-string\">xiyu/bloghtml</span><br>  <span class=\"hljs-comment\"># Hexo 编译后要部署到的分支</span><br>  <span class=\"hljs-attr\">GITEE_DEPLOY_BRANCH:</span> <span class=\"hljs-string\">main</span><br><br>  <span class=\"hljs-comment\"># 注意替换为你的 GitHub 源仓库地址</span><br>  <span class=\"hljs-attr\">GIT_SOURCE_REPO:</span> <span class=\"hljs-string\">git@github.com:xiyuvi/xiyuvi.github.io.git</span><br>  <span class=\"hljs-comment\"># 注意替换为你的 Gitee 目标仓库地址</span><br>  <span class=\"hljs-attr\">GITEE_DESTINATION_REPO:</span> <span class=\"hljs-string\">git@gitee.com:xiyu/bloghtml.git</span><br><br><span class=\"hljs-attr\">jobs:</span><br>  <span class=\"hljs-attr\">build:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span> <span class=\"hljs-string\">on</span> <span class=\"hljs-string\">node</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span> <span class=\"hljs-string\">and</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.os</span> <span class=\"hljs-string\">&#125;&#125;</span><br>    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span><br>    <span class=\"hljs-attr\">if:</span> <span class=\"hljs-string\">github.event.repository.owner.id</span> <span class=\"hljs-string\">==</span> <span class=\"hljs-string\">github.event.sender.id</span><br>    <span class=\"hljs-attr\">strategy:</span><br>      <span class=\"hljs-attr\">matrix:</span><br>        <span class=\"hljs-attr\">os:</span> [<span class=\"hljs-string\">ubuntu-18.04</span>]<br>        <span class=\"hljs-attr\">node_version:</span> [<span class=\"hljs-number\">12.</span><span class=\"hljs-string\">x</span>]<br><br>    <span class=\"hljs-attr\">steps:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Checkout</span> <span class=\"hljs-string\">deploy</span> <span class=\"hljs-string\">repo</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v2</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-attr\">repository:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_DEPLOY_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-attr\">ref:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_DEPLOY_BRANCH</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">.deploy_git</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Use</span> <span class=\"hljs-string\">Node.js</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">matrix.node_version</span> <span class=\"hljs-string\">&#125;&#125;</span><br><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Configuration</span> <span class=\"hljs-string\">environment</span><br>        <span class=\"hljs-attr\">env:</span><br>          <span class=\"hljs-attr\">HEXO_DEPLOY_PRI:</span> <span class=\"hljs-string\">$&#123;&#123;secrets.HEXO_DEPLOY_PRI&#125;&#125;</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          sudo timedatectl set-timezone &quot;Asia/Shanghai&quot;</span><br><span class=\"hljs-string\">          mkdir -p ~/.ssh/</span><br><span class=\"hljs-string\">          echo &quot;$HEXO_DEPLOY_PRI&quot; &gt; ~/.ssh/id_rsa</span><br><span class=\"hljs-string\">          chmod 600 ~/.ssh/id_rsa</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa github.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          # coding 已取消同步</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa e.coding.net &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          ssh-keyscan -t rsa gitee.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class=\"hljs-string\">          git config --global user.name $GIT_USER</span><br><span class=\"hljs-string\">          git config --global user.email $GIT_EMAIL</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Install</span> <span class=\"hljs-string\">dependencies</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          npm install hexo-cli -g</span><br><span class=\"hljs-string\">          npm install</span><br><span class=\"hljs-string\">          # 根据你安装的组件进行安装</span><br><span class=\"hljs-string\">          # npm uninstall hexo-generator-index --save</span><br><span class=\"hljs-string\">          # npm install hexo-baidu-url-submit hexo-generator-index2 hexo-symbols-count-time hexo-blog-encrypt hexo-deployer-git --save</span><br><span class=\"hljs-string\">          # 复制中文语言包，解决菜单英文的问题</span><br><span class=\"hljs-string\">          # cp zh-CN.yml node_modules/hexo-theme-next/languages/</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Deploy</span> <span class=\"hljs-string\">hexo</span><br>        <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">          npm run deploy</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Sync</span> <span class=\"hljs-string\">to</span> <span class=\"hljs-string\">Gitee</span><br>        <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">wearerequired/git-mirror-action@master</span><br>        <span class=\"hljs-attr\">env:</span><br>          <span class=\"hljs-comment\"># 直接使用了 HEXO_DEPLOY_PRI</span><br>          <span class=\"hljs-attr\">SSH_PRIVATE_KEY:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.HEXO_DEPLOY_PRI</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">with:</span><br>          <span class=\"hljs-comment\"># GitHub 源仓库地址</span><br>          <span class=\"hljs-attr\">source-repo:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GIT_SOURCE_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br>          <span class=\"hljs-comment\"># Gitee 目标仓库地址</span><br>          <span class=\"hljs-attr\">destination-repo:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">env.GITEE_DESTINATION_REPO</span> <span class=\"hljs-string\">&#125;&#125;</span><br><br>      <span class=\"hljs-comment\"># - name: Build Gitee Pages</span><br>        <span class=\"hljs-comment\"># uses: yanglbme/gitee-pages-action@main</span><br>        <span class=\"hljs-comment\"># with:</span><br>          <span class=\"hljs-comment\"># 你的 Gitee 用户名</span><br>          <span class=\"hljs-comment\"># gitee-username: $&#123;&#123; env.GITEE_USER &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 注意在 Settings-&gt;Secrets 配置 GITEE_PASSWORD</span><br>          <span class=\"hljs-comment\"># gitee-password: $&#123;&#123; secrets.GITEE_PASSWORD &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 你的 Gitee 仓库，仓库名严格区分大小写，请准确填写，否则会出错</span><br>          <span class=\"hljs-comment\"># gitee-repo: $&#123;&#123; env.GITEE_DEPLOY_REPO &#125;&#125;</span><br>          <span class=\"hljs-comment\"># 要部署的分支，默认是 master，若是其他分支，则需要指定（指定的分支必须存在）</span><br>          <span class=\"hljs-comment\"># branch: $&#123;&#123; env.GITEE_DEPLOY_BRANCH &#125;&#125;</span><br><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"html代码仓库的GitHub-Action-two\"><a href=\"#html代码仓库的GitHub-Action-two\" class=\"headerlink\" title=\"html代码仓库的GitHub Action two\"></a>html代码仓库的GitHub Action two</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ossWorkflow</span><br><br><span class=\"hljs-attr\">on:</span> [<span class=\"hljs-string\">push</span>]<br><br><span class=\"hljs-attr\">jobs:</span><br>  <span class=\"hljs-attr\">build:</span><br>    <span class=\"hljs-attr\">runs-on:</span> <span class=\"hljs-string\">ubuntu-latest</span><br>    <span class=\"hljs-attr\">steps:</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/checkout@v1</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">actions/setup-node@v1</span><br>      <span class=\"hljs-attr\">with:</span><br>        <span class=\"hljs-attr\">node-version:</span> <span class=\"hljs-string\">&quot;12.x&quot;</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Build</span> <span class=\"hljs-string\">Blog</span><br>      <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">        npm install</span><br><span class=\"hljs-string\"></span>        <br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">uses:</span> <span class=\"hljs-string\">manyuanrong/setup-ossutil@master</span><br>      <span class=\"hljs-attr\">with:</span><br>        <span class=\"hljs-comment\"># endpoint 可以去oss控制台上查看</span><br>        <span class=\"hljs-attr\">endpoint:</span> <span class=\"hljs-string\">&quot;oss-cn-chengdu.aliyuncs.com&quot;</span><br>        <span class=\"hljs-comment\"># 使用我们之前配置在secrets里面的accesskeys来配置ossutil</span><br>        <span class=\"hljs-attr\">access-key-id:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.KEY</span> <span class=\"hljs-string\">&#125;&#125;</span><br>        <span class=\"hljs-attr\">access-key-secret:</span> <span class=\"hljs-string\">$&#123;&#123;</span> <span class=\"hljs-string\">secrets.SECRET</span> <span class=\"hljs-string\">&#125;&#125;</span><br>    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">Deply</span> <span class=\"hljs-string\">To</span> <span class=\"hljs-string\">OSS</span><br>      <span class=\"hljs-attr\">run:</span> <span class=\"hljs-string\">|</span><br><span class=\"hljs-string\">        cp -ri  ./   ../output</span><br><span class=\"hljs-string\">        cd ../output</span><br><span class=\"hljs-string\">        rm -rf .git .github</span><br><span class=\"hljs-string\">        ossutil cp ./ oss://xiyublog/ -rf</span><br><span class=\"hljs-string\"></span><br></code></pre></td></tr></table></figure>\n<h2 id=\"结语\"><a href=\"#结语\" class=\"headerlink\" title=\"结语\"></a>结语</h2><p>GitHub Action还能用来做更多可以自动集成化的事情，希望大家都能挖掘出更多有意义的用法 。 </p>\n","categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"github","path":"api/tags/github.json"}]}